<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Calculate an objective function on a rolling time series for a matrix of
parameters — evalParsRollapply • hydromad</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Calculate an objective function on a rolling time series for a matrix of
parameters — evalParsRollapply"><meta property="og:description" content="For each row of a named matrix of parameters, run a model and return a
vector. By default, evalParsTS returns the predicted time series.
evalParsRollapply instead calculates an objective function on rolling
windows of the resulting time series, i.e. see how the objective function
changes over time. Special facilities are provided to evaluate large sample
sizes, including with parallelisation."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hydromad</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9-27</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/hydromad.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/tutorial.html">Tutorial</a>
    </li>
    <li>
      <a href="../articles/hbv.html">HBV model</a>
    </li>
  </ul></li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li class="dropdown-header">Releases</li>
    <li>
      <a href="http://github.com/josephguillaume/hydromad" class="external-link">hydromad 0.9-27</a>
    </li>
    <li class="divider">
    <li>
      <a href="../news/index.html">Changelog</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/josephguillaume/hydromad/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Calculate an objective function on a rolling time series for a matrix of
parameters</h1>
    <small class="dont-index">Source: <a href="https://github.com/josephguillaume/hydromad/blob/HEAD/R/evalParsRollapply.R" class="external-link"><code>R/evalParsRollapply.R</code></a></small>
    <div class="hidden name"><code>evalParsRollapply.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>For each row of a named matrix of parameters, run a model and return a
vector. By default, <code>evalParsTS</code> returns the predicted time series.
<code>evalParsRollapply</code> instead calculates an objective function on rolling
windows of the resulting time series, i.e. see how the objective function
changes over time. Special facilities are provided to evaluate large sample
sizes, including with parallelisation.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="fu">evalParsRollapply</span><span class="op">(</span>
  <span class="va">par.matrix</span>,
  <span class="va">object</span>,
  width <span class="op">=</span> <span class="fl">30</span>,
  objective <span class="op">=</span> <span class="fu"><a href="hydromad.options.html">hydromad.getOption</a></span><span class="op">(</span><span class="st">"objective"</span><span class="op">)</span>,
  parallel <span class="op">=</span> <span class="fu"><a href="hydromad.options.html">hydromad.getOption</a></span><span class="op">(</span><span class="st">"parallel"</span><span class="op">)</span><span class="op">[[</span><span class="st">"evalParsTS"</span><span class="op">]</span><span class="op">]</span>,
  filehash.name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu">evalParsTS</span><span class="op">(</span>
  <span class="va">par.matrix</span>,
  <span class="va">object</span>,
  fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">thisMod</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">thisMod</span><span class="op">)</span>,
  length.out <span class="op">=</span> <span class="cn">NULL</span>,
  <span class="va">...</span>,
  parallel <span class="op">=</span> <span class="fu"><a href="hydromad.options.html">hydromad.getOption</a></span><span class="op">(</span><span class="st">"parallel"</span><span class="op">)</span><span class="op">[[</span><span class="st">"evalParsTS"</span><span class="op">]</span><span class="op">]</span>,
  filehash.name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>par.matrix</dt>
<dd><p>Named matrix or data.frame of parameter values, with each
row corresponding to a model realisation to evaluate</p></dd>
<dt>object</dt>
<dd><p>an object of class <code>hydromad</code>.</p></dd>
<dt>width</dt>
<dd><p>integer specifying window width, aligned center. Passed to
<code><a href="https://rdrr.io/pkg/zoo/man/rollapply.html" class="external-link">rollapply</a></code></p></dd>
<dt>objective</dt>
<dd><p>the objective function or expression, which can refer to Q
and X.  See <code><a href="objFunVal.html">objFunVal.hydromad</a></code></p></dd>
<dt>parallel</dt>
<dd><p>If <code>"clusterApply"</code>, evaluate parameters in parallel
using a local cluster. The implementation assumes that the <code>ff</code>
file <code>filehash.name</code> can be written to simultaneously all cluster
workers.</p></dd>
<dt>filehash.name</dt>
<dd><p>Name of <code>ff</code> file in which to store
results, allowing large samples that do not fit in memory. Defaults to
<code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile()</a></code>, which is automatically deleted when exiting from R. To
store results in memory, set <code>filehash.name=NULL</code>.</p></dd>
<dt>fun</dt>
<dd><p>function that takes a hydromad object and returns a vector, by
default the fitted timeseries.</p></dd>
<dt>length.out</dt>
<dd><p>Length of output vector returned by <code>fun</code>. If
missing, <code>fun</code> will be run on the first parameter set in
<code>par.matrix</code>.</p></dd>
<dt>...</dt>
<dd><p>Additional arguments to <code>fun</code></p></dd>
</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>Either a matrix or <code>ff</code> file-backed matrix, with each
row being a time series of rolling objective functions for the corresponding
row of <code>par.matrix</code></p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>If timeseries are long, then the results matrix will be large
(<code>nrow(par.matrix)</code> x <code>length.out</code>). By default the results matrix
is therefore stored in a <code>ff</code> file-backed matrix.</p>
<p>Individual model evaluations are generally very fast, so parallelisation is
only really worthwhile when large numbers of evaluations are needed.
Parallelisation method <code>"clusterApply"</code> uses multiple R sessions that
write to a shared <code>ff</code> object. It only operates on a single
multicore machine. Parallelisation method <code>"foreach"</code> offers a broader
range of options but only works if the final results matrix is small enough
to fit in memory.</p>
    </div>
    <div id="note">
    <h2>Note</h2>
    <p>When using <code>ff</code>, performance may be improved by specifying
<code>options(ffcaching='mmeachflush')</code>.</p>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>Herman, J. D., P. M. Reed, and T. Wagener. 2013. "Time-Varying
Sensitivity Analysis Clarifies the Effects of Watershed Model Formulation on
Model Behavior." Water Resources Research 49 (3): 1400-1414.
doi: <a href="http://dx.doi.org/10.1002/wrcr.2012410.1002/wrcr.20124" class="external-link">here</a></p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="evalPars.html">evalPars</a></code> to calculate a single objective function for
each parameter set</p></div>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Joseph Guillaume</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Cotter</span><span class="op">)</span></span>
<span class="r-in"><span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">Cotter</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">]</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## Define rainfall-runoff model structure</span></span>
<span class="r-in"><span class="va">object</span> <span class="op">&lt;-</span> <span class="fu"><a href="hydromad.html">hydromad</a></span><span class="op">(</span><span class="va">obs</span>,</span>
<span class="r-in">  sma <span class="op">=</span> <span class="st">"cwi"</span>, routing <span class="op">=</span> <span class="st">"expuh"</span>,</span>
<span class="r-in">  tau_q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, tau_s <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">100</span><span class="op">)</span>, v_s <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span class="r-in"><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## Set the random seed to obtain replicable results</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">19</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># Draw 10 Latin Hypercube random samples</span></span>
<span class="r-in"><span class="va">par.matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="parameterSets.html">parameterSets</a></span><span class="op">(</span><span class="fu"><a href="evalPars.html">getFreeParsRanges</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span>, samples <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span class="r-in"><span class="co"># Calculate rolling time series of r.squared for each parameter set,</span></span>
<span class="r-in"><span class="co">#   keeping results in memory</span></span>
<span class="r-in"><span class="va">runs</span> <span class="op">&lt;-</span> <span class="fu">evalParsRollapply</span><span class="op">(</span><span class="va">par.matrix</span>, <span class="va">object</span>,</span>
<span class="r-in">  objective <span class="op">=</span> <span class="fu"><a href="hydromad.stats.html">hmadstat</a></span><span class="op">(</span><span class="st">"r.squared"</span><span class="op">)</span>, filehash.name <span class="op">=</span> <span class="cn">NULL</span></span>
<span class="r-in"><span class="op">)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Running 10 model evaluations with parallelisation='none'</span>
<span class="r-in"><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span class="r-in"><span class="co">## Setup parallelisation on three cores</span></span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="hydromad.options.html">hydromad.options</a></span><span class="op">(</span><span class="st">"parallel"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"evalParsTS"</span> <span class="op">=</span> <span class="st">"clusterApply"</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span><span class="va">cl</span>, <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://hydromad.catchment.org/" class="external-link">hydromad</a></span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">par.matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="parameterSets.html">parameterSets</a></span><span class="op">(</span><span class="fu"><a href="evalPars.html">getFreeParsRanges</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span>, samples <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span class="r-in"><span class="co"># Calculate rolling time series of r.squared for each parameter set,</span></span>
<span class="r-in"><span class="co">#  storing result in tempfile()</span></span>
<span class="r-in"><span class="co"># Takes about 2 minutes</span></span>
<span class="r-in"><span class="va">runs</span> <span class="op">&lt;-</span> <span class="fu">evalParsRollapply</span><span class="op">(</span><span class="va">par.matrix</span>, <span class="va">object</span>,</span>
<span class="r-in">  objective <span class="op">=</span> <span class="fu"><a href="hydromad.stats.html">hmadstat</a></span><span class="op">(</span><span class="st">"r.squared"</span><span class="op">)</span></span>
<span class="r-in"><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># Excerpt of results</span></span>
<span class="r-in"><span class="va">runs</span></span>
<span class="r-in"><span class="co"># Path of backing file - about 7MB</span></span>
<span class="r-in"><span class="fu">filename</span><span class="op">(</span><span class="va">runs</span><span class="op">)</span></span>
<span class="r-in"><span class="co"># ff object can be used like a regular matrix, e.g. plotting the</span></span>
<span class="r-in"><span class="co">#  rolling time series of R.squared for the first parameter set</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">runs</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## Do the same with foreach</span></span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="hydromad.options.html">hydromad.options</a></span><span class="op">(</span><span class="st">"parallel"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"evalParsTS"</span> <span class="op">=</span> <span class="st">"foreach"</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"><span class="va">runs</span> <span class="op">&lt;-</span> <span class="fu">evalParsRollapply</span><span class="op">(</span><span class="va">par.matrix</span>, <span class="va">object</span>,</span>
<span class="r-in">  objective <span class="op">=</span> <span class="fu"><a href="hydromad.stats.html">hmadstat</a></span><span class="op">(</span><span class="st">"r.squared"</span><span class="op">)</span>, filehash.name <span class="op">=</span> <span class="cn">NULL</span></span>
<span class="r-in"><span class="op">)</span></span>
<span class="r-in"><span class="co">## runs is a matrix</span></span>
<span class="r-in"><span class="op">}</span></span>
<span class="r-in"></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Joseph Guillaume.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer></div>

  


  

  </body></html>

